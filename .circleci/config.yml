version: 2.1

jobs:
  test_regression_model:
    docker:
      # Utilisation d'une image Python 3.9 standard
      - image: cimg/python:3.9

    steps:
      # Étape 1 : Récupération du code source depuis le dépôt Git
      - checkout

      # Étape 2 : Diagnostic de la structure du projet
      - run:
          name: Analyse de l'arborescence du projet
          command: |
            # Affichage du chemin courant pour comprendre où on se trouve
            echo "Répertoire courant :"
            pwd
            # Liste des éléments à la racine du projet
            echo "Contenu du répertoire :"
            ls
            # Focus sur le dossier spécifique du cours A61
            echo "Contenu du dossier cours-A61 :"
            ls cours-A61

      # Étape 3 : Configuration de l'environnement Python
            
      - run:
          name: Installation des dépendances nécessaires
          command: |
            cd cours-A61
            # Mise à jour de pip
            python -m pip install --upgrade pip

            # Installation des dépendances du modèle de régression
            python -m pip install -r packages/regression_model/requirements.txt

            # Installation du package regression_model en mode editable (local)
            python -m pip install -e packages/regression_model

            # Installation des dépendances de l’API Flask
            python -m pip install -r packages/ml_api/requirements.txt
      

      # Étape 4 : Configuration de l'accès à Kaggle
      - run:
          name: Préparation de l'outil Kaggle pour télécharger les données
          command: |
            # Installation de l'interface en ligne de commande de Kaggle
            python -m pip install --no-cache-dir kaggle

            # Création du fichier de configuration Kaggle
            # Les identifiants sont fournis par les variables d'environnement CircleCI
            mkdir -p ~/.kaggle
            echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
            # Protection du fichier contenant les clés d'API
            chmod 600 ~/.kaggle/kaggle.json

      # Étape 5 : Acquisition du jeu de données
      - run:
          name: Téléchargement des données depuis Kaggle
          command: |
            # Exécution du script qui récupère le dataset House Prices
            cd cours-A61
            bash scripts/fetch_kaggle_dataset.sh
            

      # Étape 6 : Entraînement du modèle de machine learning         
      - run:
          name: Création du modèle entraîné
          command: |
            cd cours-A61
            # On ajoute le dossier "packages" au PYTHONPATH pour que "regression_model" soit importable
            export PYTHONPATH="$PYTHONPATH:$(pwd)/packages"

            # On lance le pipeline d'entraînement en tant que module installé
            python -m regression_model.train_pipeline
     

      # Étape 7 : Vérification par les tests automatisés
      - run:
          name: Exécution des tests de validation
          command: |
            cd cours-A61
            # On ajoute "packages" (pour regression_model) et "packages/ml_api" (pour l'API Flask)
            export PYTHONPATH="$PYTHONPATH:$(pwd)/packages:$(pwd)/packages/ml_api"
            pytest -q


      # Étape 8 : Archivage des artefacts produits
      - store_artifacts:
          # Chemin vers les modèles entraînés (fichiers .pkl)
          path: cours-A61/packages/regression_model/regression_model/trained_models
          # Nom du dossier dans l'interface CircleCI
          destination: trained_models

# Définition du workflow principal
workflows:
  version: 2
  test-all:
    jobs:
      # Notre unique job pour le moment : tester tout le pipeline
      - test_regression_model