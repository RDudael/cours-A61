version: 2.1

jobs:
  test_regression_model:
    docker:
      - image: cimg/python:3.9  # Image Python 3.9 standard

    steps:
      - checkout  # Récupère tout le code du dépôt Git

      - run:
          name: Exploration de la structure du projet
          command: |
            # Phase de diagnostic : on vérifie où on est et ce qu'il y a autour
            echo "Nous sommes à la racine du dépôt Git :"
            pwd
            echo "Voici ce qu'il y a ici :"
            ls
            echo "-----------------------------"
            echo "Maintenant, on se déplace dans le dossier du cours A61"
            cd cours-A61
            echo "Nous sommes maintenant ici :"
            pwd
            echo "Contenu du dossier cours-A61 :"
            ls
            echo "Et plus précisément, voici les packages disponibles :"
            ls packages

      - run:
          name: Mise en place de l'environnement Python
          command: |
            # On se positionne dans le bon dossier
            cd cours-A61
            # Mise à jour de pip (toujours une bonne pratique)
            pip install --upgrade pip
            # Installation des dépendances listées dans requirements.txt
            pip install -r packages/regression_model/requirements.txt
            # Installation du package en mode développement
            # Cela permet de le modifier sans devoir le réinstaller
            pip install -e packages/regression_model

      - run:
          name: Récupération des données d'entraînement
          command: |
            # On se replace dans le dossier du cours
            cd cours-A61
            # Exécution du script qui va chercher les données sur Kaggle
            bash scripts/fetch_kaggle_dataset.sh

      - run:
          name: Entraînement du modèle de régression
          command: |
            # Toujours dans le dossier du cours
            cd cours-A61
            # Lancement du script d'entraînement principal
            # Cela va créer le fichier .pkl (l'artefact du modèle)
            python -m regression_model.train_pipeline

      - run:
          name: Vérification par les tests unitaires
          command: |
            # On se déplace dans le dossier du modèle pour lancer les tests
            cd cours-A61/packages/regression_model
            # Exécution des tests en mode silencieux (seulement le résultat)
            pytest -q

workflows:
  test-all:
    jobs:
      - test_regression_model  # Notre pipeline de test principal