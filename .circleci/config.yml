jobs:
  test_regression_model:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout  # Téléchargement du code source depuis Git

      - run:
          name: Explorer l'organisation du projet
          command: |
            # Vérification de la structure des dossiers
            # ...
      
      - run:
          name: Préparation de l'environnement Python
          command: |
            # Mise à jour de pip et installation des dépendances du projet
            pip install --upgrade pip
            pip install -r cours-A61/packages/regression_model/requirements.txt

      # ÉTAPE CRUCIALE : Installation et configuration de Kaggle
      - run:
          name: Configuration de l'outil Kaggle pour télécharger les données
          command: |
            # Installation de la ligne de commande Kaggle
            pip install --no-cache-dir kaggle

            # Création du fichier de configuration Kaggle
            # Les identifiants sont récupérés depuis les variables CircleCI
            mkdir -p ~/.kaggle
            echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
            # Sécurité : restriction des permissions sur le fichier contenant les clés
            chmod 600 ~/.kaggle/kaggle.json

      - run:
          name: Acquisition du dataset depuis Kaggle
          command: |
            # Exécution du script qui télécharge les données
            cd cours-A61
            bash scripts/fetch_kaggle_dataset.sh

      # entraînement du modèle, exécution des tests, gestion des artefacts

      - run:
          name: Entraînement du modèle de régression
          command: |
            # Toujours dans le dossier du cours
            cd cours-A61
            # Lancement du script d'entraînement principal
            # Cela va créer le fichier .pkl (l'artefact du modèle)
            python -m regression_model.train_pipeline

      - run:
          name: Vérification par les tests unitaires
          command: |
            # On se déplace dans le dossier du modèle pour lancer les tests
            cd cours-A61/packages/regression_model
            # Exécution des tests en mode silencieux (seulement le résultat)
            pytest -q

workflows:
  test-all:
    jobs:
      - test_regression_model  # Notre pipeline de test principal